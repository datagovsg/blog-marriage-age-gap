<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Groom/Bride Age Difference</title>
    <link rel="stylesheet" href="lib/plottable.css">
    <link rel="stylesheet" href="lib/datagovsg-charts.css">
    <style>
      html, body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
      }

      .chart-title {
        margin-top: 50px;
      }

      .chart-container {
        margin: 30px auto 50px;
        max-width: 800px;
        height: 500px;
      }

      .chart-controls label, .chart-controls input {
        vertical-align: top;
      }

      input[name="year"] {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <h2 class="chart-title">Groom vs Bride Age Difference (<span class="year-text">1994</span>)</h2>
    <div class="chart-container">
      <svg id="chart" height="100%" width="100%"></svg>
    </div>
    <div class="chart-controls">
      <label for="type">Type:</label>
      <input type="button" name="type" id="type" value="First Marriages">
      <br>
      <label for="year">Year:</label>
      <input type="range" name="year" min="1994" max="2015" step="1" value="1994" id="year">
    </div>

    <script src="lib/d3.min.js"></script>
    <script src="lib/plottable.min.js"></script>
    <script src="lib/datagovsg-charts.min.js"></script>
    <script src="lib/pivot-table.min.js"></script>
    <script src="lib/papaparse.min.js">
    </script>
    <script type="text/javascript">
      const {DatagovsgSimpleBar} = DatagovsgCharts
      const getScale = DatagovsgCharts.helpers.getScale
      const {filterItems, filterGroups, groupItems, aggregate} = PivotTable

      const ageDifference = {
        'Groom Younger By 4 Years': -4,
        'Groom Younger By 3 Years': -3,
        'Groom Younger By 2 Years': -2,
        'Groom Younger By 1 Year': -1,
        'Same Age': 0,
        'Groom Older By 1 Year': 1,
        'Groom Older By 2 Years': 2,
        'Groom Older By 3 Years': 3,
        'Groom Older By 4 Years': 4,
        'Groom Older By 5 Years': 5,
        'Groom Older By 6 Years': 6,
        'Groom Older By 7 Years': 7,
        'Groom Older By 8 Years': 8,
        'Groom Older By 9 Years': 9,
        'Groom Older By 10 Years': 10,
        'Groom Older By 11 Years': 11,
        'Groom Older By 12 Years': 12
      }

      Papa.parse('data.csv', {
        download: true,
        header: true,
        complete (results) {
          results.data.forEach(d => {
            d.ageDifference = ageDifference[d.level_2]
          })

          const pivotTable = new PivotTable(results.data)
          pivotTable.push(filterItems(d => !isNaN(d.ageDifference)))
          pivotTable.push(groupItems('year'))
          pivotTable.push(groupItems('level_1'))
          pivotTable.push(filterGroups('level_1', {type: 'exclude', values: ['Total']}))
          pivotTable.push(aggregate('ageDifference', 'value'))
          const processed = pivotTable.transform()

          processed.forEach(g => {
            g._summaries[0].series.sort((a, b) => a.label - b.label)
          })

          const scale = getScale()
          const chart = new DatagovsgSimpleBar({
            scale: scale.domain([0, 3500]),
            xLabel: 'Years Difference in Age',
            yLabel: 'Number of Couples',
            animated: false
          })
          chart.mount(document.getElementById('chart'))
          window.chart = chart

          function updateChart (year, type) {
            const match = processed.filter(g => g._group.year === year && g._group.level_1 === type)[0]
            if (match) chart.update({data: match._summaries[0].series})
          }

          const typeControl = document.querySelector('input[name="type"]')
          const yearControl = document.querySelector('input[name="year"]')
          const yearText = document.querySelector('.year-text')

          typeControl.addEventListener('click', event => {
            if (typeControl.value === 'First Marriages') {
              typeControl.value = 'Remarriages'
              scale.domain([0, 500])
            } else {
              typeControl.value = 'First Marriages'
              scale.domain([0, 3500])
            }
            updateChart(yearControl.value, typeControl.value)
          })
          yearControl.addEventListener('change', event => {
            updateChart(yearControl.value, typeControl.value)
            yearText.textContent = yearControl.value
          })

          updateChart('1994', 'First Marriages')

          setInterval(() => {
            const current = +yearControl.value
            const next = current < 2015 ? current + 1 : 1994
            yearControl.value = next.toString()
            updateChart(yearControl.value, typeControl.value)
            yearText.textContent = yearControl.value
          }, 1000)
        }
      })
    </script>
  </body>
</html>
